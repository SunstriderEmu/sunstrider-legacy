<!----------------------------------------------------------------------------->
# Install on Windows

## Compiling The Server

The only windows compiler supported for now is MSVC 14 (Visual Studio Community 2015). The server can be compiled
in x64 or x86, in Release or Debug mode.

When downloading dependencies (such as OpenSSL, Boost or MariaDB) you must get the
version corresponding to the compiler version (x86 or x64) you will use, else
the linking will fail.

1. Get Git, and clone the repository
   (https://github.com/kelno/sunstrider.git).

2. Install [CMake][cmake]

3. Install [OpenSSL][openssl] note the directory to which you
   install it. Caution, do not use the 'Light' version.

4. Install [Boost 1.58][boost] or newer to a directory of your choice. Set the
   **environment** variable (not a CMake variable) `BOOST_ROOT` to wherever you
   installed Boost.

5. Run `cmake-gui` and indicate the repository as the source directory, and a
   directory of your choice to hold the compiled artifacts.

5. Install MariaDB, as instructed in the "Setting Up The DB" section below.

6. Click Configure, then tweak the variables that appear.

   In particular, you should make sure that the `SSL_EAY_*` and `LIB_EAY_*` variables point to the
   right version of OpenSSL (usually the one you installed at step 3).
   If CMake has trouble finding OpenSSL, make sure the system variable OPENSSL_ROOT_DIR exists and is correctly set.

   Set `CMAKE_INSTALL_PREFIX` to the location where you want the server to be
   installed. This is where the "INSTALL" project generated by CMake will
   install the binaries.

   If you installed MariaDB in an unusual way (e.g. by unzipping binaries or
   compiling manually), indicate the location of the MySQL dynamic libraries in
   a new variable named `MYSQL_ADD_LIBRARIES_PATH`; and the location of the
   MySQL headers in a new variabled named `MYSQL_ADD_INCLUDE_PATH`.

7. Click Generate, and select your compiler. 

8. Open the `Sunstrider.sln` solution generated in the build directory.

9. Right-click the `INSTALL` project, then click `build`.

[cmake]:
http://www.cmake.org/cmake/resources/software.html

[openssl]:
http://slproweb.com/products/Win32OpenSSL.html

[boost]:
http://sourceforge.net/projects/boost/files/boost-binaries/1.60.0/

<!----------------------------------------------------------------------------->
## Setting Up The DB

1. Download [MariaDB][maria_db] 10.x series) and install it. Be sure to note
   down your root password, and the port you select if it not the default. If
   you don't already have an SQL client, you can install HeidiSQL when proposed
   to do so.

2. Download the last world database [here][world_db], copy it to the `sql`
   directory in the repository then rename it to `world.sql` (so that it is ignored by Git and taken into account by the script at step 3).

3. If this is a first-time setup, switch to the `sql` sub-directory of the
   repository, then run `mysql -u root -p < create_mysql.sql` then `mysql -u
   root -p < populate_mysql.sql`.

4. Apply every 'world', 'char', 'auth' updates in the `sql/updates` directory,
   applying them from the lowest date to the highest.

   Under bash, this can be achieved by running the `apply_updates.sh` script
   that is in the `sql` directory.

   *When the database creation scripts are updated, those updates are moved to
   the `sql/updates/old` directory and are not needed anymore.*

As an aside, you can dispense with the `-u root -p` part if you [configure the
user and password in the `my.ini` file][my_ini].

[maria_db]:
https://downloads.mariadb.org/

[world_db]:
https://github.com/kelno/sunstrider/releases

[my_ini]:
http://www.avajava.com/tutorials/lessons/how-do-i-log-on-to-mysql-automatically.html

<!----------------------------------------------------------------------------->
## Extracting maps, vmaps and dbc

You can skip this step by downloading [the already extracted data folders][githubdata] and extracting them into your `<install dir>/data` folder.

Otherwise, if those files were missing, outdated, if if you want to do it by yourself, follow these steps after compiling the core.

- Copy `dep/lib/<build>_release/libmySQL.dll` from the source directory to your 
  burning crusade install directory. (This dependency should be removed)

- Copy `src/tools/map_extractor/<configuration>/mapextractor.exe`from the build
  directory to your burning crusade install directory.

- Copy `src/tools/mmaps_generator/<configuration>/mmaps_generator.exe` from the build
  directory to your burning crusade install directory.

- Copy `src/tools/vmap4_extractor/<configuration>/vmap4extractor.exe` from the build
  directory to your burning crusade install directory.

- Copy `src/tools/vmap4_assembler/<configuration>/vmap4assembler.exe` from the build
  directory to your burning crusade install directory.

- Run `mapextractor.exe` in the game directory. This will create two directories
  named `maps` and `dbc`.

- Run `vmap4extractor.exe` in the game directory. This will create a directory
  named `Buildings`.

- Create a directory named `vmaps`, then run `vmap4assembler.exe Buildings
  vmaps` in the game directory.

- Create a directory named `mmaps`, then run `mmaps_generator.exe` in the game
  directory.

- Move the directories `maps`, `dbc`, `vmaps` and `mmaps` from your game
  directory to your server install location. This was the value of the
  `CMAKE_INSTALL_PREFIX` variable inside CMake. If you're not sure, you can
  re-run `cmake-gui` to check. You can delete the `Buildings` directory.


[githubdata]:
https://github.com/kelno/sunstrider/releases

<!----------------------------------------------------------------------------->
## Install and Configure the Server

- Copy to your server install directory :

	- `libeay32.dll` from the OpenSSL install directory.
	- `dep/lib/<build>_release/libmySQL.dll` (from there or from your MariaDB
      directory)
	- `dep/lib/<build>_release/libircclient.dll`

<!-- comment for spacing -->

- Rename `authserver.conf.dist` from your server install directory to
  `authserver.conf`.

- Rename `worldserver.conf.dist` from your server install directory to
  `worldserver.conf`.

- Update `authserver.conf` options:  
	- **LoginDatabaseInfo**: See info in conf file
	
- Update `worldserver.conf` options:  
	- **LoginDatabaseInfo**: See info in conf file
	- **WorldDatabaseInfo**: See info in conf file
	- **CharacterDatabaseInfo**: See info in conf file
	- **LogsDatabaseInfo**: See info in conf file
	- **DataDir**: Set this your data folder you just filled last step.
	- **LogsDir***: Because you'll probably want logs. See info in conf file.

Local realmlist entries are already configured in database for BC and LK, so you don't need
to add one yourself for development. If you need to, just look at the structure
of the `realmlist` table in the `auth` database.

Some dummy accounts are already in the database, from `test1` to `test5`. The
password are the usernames.

<!----------------------------------------------------------------------------->
## Running the Server

### Running From Visual Studio

You need to change the output directory of the executables so that they get put
somewhere where the config files and DLLs are available (typically, the "install
directory").

You may also want to change the working directory of the worldserver project 
to the same folder to be able to easily run the worldserver in the visual studio 
debugger. (If you do don't forget to also right click the worldserver and set 
as startup project.)

To change the output directories, right click the `worldserver` project, then
edit Properties > Configuration Properties > Output Directory. Same for the
`authserver` project. Beware that this change will reset each time you
regenerate the Visual Studio Project files using CMake!

Finally, you need to set the working directory to the folder where you put all
those dll and config files, else the server won't be able to find them.

### Running From Windows

By default, the executables and debug informations will be put into
`<build_dir>/src/worldserver/<vs_config>` and
`<build_dir>/src/authserver/<vs_config>`. So for instance
`<build_dir>/src/worldserver/<configuration>`. Follow the instruction from the
previous section to change that to your install directory.

Alternatively, you can copy them manually to your install directory. Normally,
the INSTALL job should take care of this, but it is currently broken. You need
to change the directory output path to run from VS anyway, so it's not a big
annoyance.
